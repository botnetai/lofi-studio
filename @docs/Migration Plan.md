## Migration Plan

### Purpose of the App
- Enable users to create “Spaces” that combine generated audio (ElevenLabs) and visuals (Fal.ai image/video) into shareable, optionally public experiences.
- Each Space has its own URL, configurable privacy (private/public), and an optional chat/trollbox that can be toggled per Space.
- Two plans: Free (1 Space total, lifetime) and Pro (up to 10 Spaces). Stripe (web) and RevenueCat (mobile) power billing, subscriptions, and upgrades.

### Pages
1. Explore - a feed of spaces created by the user or community
2. Space - A Space is an entity owned by a user that plays media (songs, images, videos). It is inspired by the Lofi Girl YouTube channel in which users can navigate to and put it on in the background.
3. CRUD Space - form to generate and edit music, image, video, title, etc.
4. Settings

### Spaces: Product Model
- A Space is an entity owned by a user that aggregates media (songs, images, videos).
- Each Space includes:
  - `visibility`: `private` or `public`.
  - `slug` for shareable URL at `/space/[slug]`.
  - `chat_enabled`: toggle for chat/trollbox.
  - `songs`: ordered list of generated tracks that belong to the Space.
  - `background`: a single static image or looping video associated with the Space.
- Free plan: 1 Space total (lifetime). Pro plan: up to 10 Spaces total.

### Context and Goals
- Replace legacy with a modern, scalable app.
- Centralize music generation on ElevenLabs; keep Fal.ai for image/video.
- Deliver a production-ready web app with auth, storage, typed APIs, robust UX, and observability.
- We have no existing users/data to preserve; legacy code and schemas can be discarded.

### Target Stack Recap
- **Web**: Next.js (App Router), TypeScript, Tailwind v4, shadcn/ui, TanStack Query, tRPC. Local dev may use Bun.
- **Mobile**: Expo (React Native), Expo Router, TypeScript, TanStack Query, `expo-av` for media.
- **Auth/DB**: Supabase (Auth + Postgres, RLS + Policies).
- **Storage**: Cloudflare R2 S3-compatible (music/images/videos), public objects with unguessable keys (no presign/CDN for MVP)
- **Generation**: ElevenLabs (music), Fal.ai (image/video).
- **Platform/Email/Payments**: Vercel, Resend, Stripe (web), RevenueCat (mobile).

- Next.js serves UI and tRPC route handlers (server-only code remains on server).
- tRPC server integrates providers (ElevenLabs/Fal.ai) and persists results in Supabase and R2.
- Server polls providers for job status and writes final media to R2 (provider webhooks deferred to Hardening).
- RLS ensures users only access their own rows.
- Media is delivered via public R2 objects with unguessable keys (no presign/CDN for MVP).

### Spaces: Product Model
- A Space is an entity owned by a user that plays media (songs, images, videos). It is inspired by the Lofi Girl youtube channel in which users can navigate to and put it on in the background.
- Free plan: 1 Space total (lifetime). Pro plan: up to 10 Spaces total.
- Each Space includes:
  - `visibility`: `private` or `public`.
  - `name`
  - `slug` for shareable URL at `/space/[slug]`.
  - `chat_enabled`: toggle for chat/trollbox.
  - `songs`: background music generated by ElevenLabs
  - `background`: exactly one background, which can be an image or a looping video


### Sound Effects (SFX) Overlays
- Purpose: allow users to layer ambient loops (e.g., rain, storm, crackling fire) over generated background music.
- Client-first mixing (MVP):
  - Web: Web Audio API mixes base music + one or more looping SFX with independent volume sliders.
  - Mobile (Expo): `expo-av` plays base track + looping SFX in sync; volume sliders; handle iOS/Android playback quirks.
- Persistence:
  - Store selected SFX for a Space as rows (`space_sfx`) or embed in `spaces` metadata.
  - Effects catalog (`sfx_effects`) keeps R2 keys and defaults.
- Optional pre-mix (export-ready):
  - Server-side mix variants using ffmpeg or a hosted audio service (deferred); writes pre-mixed audio to R2 for sharing/exports and later video compilations.

## Database Schema (Supabase)

```sql
-- Enable functions for UUIDs if needed
create extension if not exists pgcrypto;

-- Spaces (new)
create table if not exists public.spaces (
  id uuid primary key default gen_random_uuid(),
  user_id uuid not null references auth.users(id) on delete cascade,
  name text not null,
  slug text not null unique,
  visibility text not null check (visibility in ('private','public')) default 'private',
  chat_enabled boolean not null default false,
  description text,
  background_artwork_id uuid references public.artwork(id),
  background_video_id uuid references public.videos(id),
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now()
);

-- Ensure only one background type is set at a time (idempotent)
alter table public.spaces
  add constraint if not exists spaces_single_background_chk
  check (not (
    background_artwork_id is not null and background_video_id is not null
  ));

-- Songs (belong to a Space)
create table if not exists public.songs (
  id uuid primary key default gen_random_uuid(),
  user_id uuid not null references auth.users(id) on delete cascade,
  space_id uuid not null references public.spaces(id) on delete cascade,
  position int not null,
  title text,
  prompt text,
  provider text not null default 'elevenlabs',
  generation_id text,
  status text not null check (status in ('queued','generating','completed','failed')) default 'queued',
  duration_seconds int,
  r2_key text,
  r2_url text,
  metadata jsonb not null default '{}',
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now()
);

-- Background: Artwork
create table if not exists public.artwork (
  id uuid primary key default gen_random_uuid(),
  user_id uuid not null references auth.users(id) on delete cascade,
  prompt text,
  model text not null default 'fal-ai/flux-pro',
  request_id text,
  status text not null check (status in ('queued','generating','completed','failed')) default 'queued',
  r2_key text,
  r2_url text,
  metadata jsonb not null default '{}',
  created_at timestamptz not null default now()
);

-- Background: Videos
create table if not exists public.videos (
  id uuid primary key default gen_random_uuid(),
  user_id uuid not null references auth.users(id) on delete cascade,
  artwork_id uuid references public.artwork(id) on delete set null,
  prompt text,
  model text not null default 'fal-ai/kling-2.1',
  request_id text,
  status text not null check (status in ('queued','generating','completed','failed')) default 'queued',
  r2_key text,
  r2_url text,
  duration_seconds int,
  metadata jsonb not null default '{}',
  created_at timestamptz not null default now()
);

-- Space chat messages (Supabase Realtime)
create table if not exists public.space_messages (
  id uuid primary key default gen_random_uuid(),
  space_id uuid not null references public.spaces(id) on delete cascade,
  user_id uuid not null references auth.users(id) on delete cascade,
  message text not null,
  created_at timestamptz not null default now()
);

-- (Removed) Songs are scoped directly to a Space via songs.space_id and ordered by songs.position

-- Subscriptions/entitlements (Stripe-backed)
create table if not exists public.user_subscriptions (
  user_id uuid primary key references auth.users(id) on delete cascade,
  plan text not null check (plan in ('free','pro')) default 'free',
  stripe_customer_id text,
  stripe_subscription_id text,
  status text,
  current_period_end timestamptz,
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now()
);

-- Indexes
create index if not exists idx_songs_user_created on public.songs(user_id, created_at desc);
create index if not exists idx_songs_space_pos on public.songs(space_id, position);
create unique index if not exists uidx_songs_space_position on public.songs(space_id, position);
create index if not exists idx_artwork_user_created on public.artwork(user_id, created_at desc);
create index if not exists idx_videos_user_created on public.videos(user_id, created_at desc);
create index if not exists idx_spaces_user_created on public.spaces(user_id, created_at desc);
create index if not exists idx_space_messages_space_created on public.space_messages(space_id, created_at desc);

-- updated_at trigger
create or replace function public.set_updated_at() returns trigger as $$
begin
  new.updated_at = now();
  return new;
end;
$$ language plpgsql;

drop trigger if exists trg_songs_updated_at on public.songs;
create trigger trg_songs_updated_at before update on public.songs for each row execute function public.set_updated_at();

drop trigger if exists trg_spaces_updated_at on public.spaces;
create trigger trg_spaces_updated_at before update on public.spaces for each row execute function public.set_updated_at();

drop trigger if exists trg_user_subs_updated_at on public.user_subscriptions;
create trigger trg_user_subs_updated_at before update on public.user_subscriptions for each row execute function public.set_updated_at();

-- RLS policies (examples)
-- Enable RLS (safe to re-run)
alter table public.spaces enable row level security;
alter table public.songs enable row level security;
alter table public.artwork enable row level security;
alter table public.videos enable row level security;
alter table public.space_messages enable row level security;
alter table public.user_subscriptions enable row level security;

-- Drop existing policies (safe if they don't exist)
drop policy if exists spaces_select_public_or_own on public.spaces;
drop policy if exists spaces_modify_own on public.spaces;
drop policy if exists songs_select_own_or_public_space on public.songs;
drop policy if exists songs_modify_own on public.songs;
drop policy if exists artwork_select_own on public.artwork;
drop policy if exists artwork_modify_own on public.artwork;
drop policy if exists videos_select_own on public.videos;
drop policy if exists videos_modify_own on public.videos;
drop policy if exists space_messages_select_public_or_own on public.space_messages;
drop policy if exists space_messages_insert_own_space on public.space_messages;
drop policy if exists space_messages_delete_own on public.space_messages;
drop policy if exists user_subscriptions_own on public.user_subscriptions;

-- Recreate policies
create policy spaces_select_public_or_own on public.spaces
  for select using (visibility = 'public' or user_id = auth.uid());

create policy spaces_modify_own on public.spaces
  for all using (user_id = auth.uid()) with check (user_id = auth.uid());

create policy songs_select_own_or_public_space on public.songs
  for select using (
    user_id = auth.uid() or exists (
      select 1 from public.spaces s
      where s.id = songs.space_id and s.visibility = 'public'
    )
  );

create policy songs_modify_own on public.songs
  for all using (user_id = auth.uid()) with check (user_id = auth.uid());

create policy artwork_select_own on public.artwork
  for select using (user_id = auth.uid());

create policy artwork_modify_own on public.artwork
  for all using (user_id = auth.uid()) with check (user_id = auth.uid());

create policy videos_select_own on public.videos
  for select using (user_id = auth.uid());

create policy videos_modify_own on public.videos
  for all using (user_id = auth.uid()) with check (user_id = auth.uid());

create policy space_messages_select_public_or_own on public.space_messages
  for select using (
    exists (
      select 1 from public.spaces s
      where s.id = space_messages.space_id
        and (s.visibility = 'public' or s.user_id = auth.uid())
    )
  );

create policy space_messages_insert_own_space on public.space_messages
  for insert with check (
    exists (
      select 1 from public.spaces s
      where s.id = space_messages.space_id
        and s.user_id = auth.uid()
    )
  );

create policy space_messages_delete_own on public.space_messages
  for delete using (user_id = auth.uid());

create policy user_subscriptions_own on public.user_subscriptions
  for all using (user_id = auth.uid()) with check (user_id = auth.uid());
```

### Music Flow (step-by-step)
1. `trpc.music.create` inserts `songs` with `status='queued'` and required `spaceId` (sets `space_id` and next `position`), calls ElevenLabs; store `generation_id`; set `status='generating'`.
2. Server polls ElevenLabs until completion (no provider webhooks in MVP).
3. Server downloads audio stream, uploads to R2 `music/{songId}.mp3`, updates DB status/metadata/duration.
4. Client lists and plays via `<audio>` using public R2 URL.

---

## Build & Deployment
- Dev tooling:
  - Scripts (pnpm/npm; Bun optional locally): `dev`, `build`, `start`, `typecheck`, `lint`, `test`.
  - TypeScript strict, ESLint + Prettier, shadcn/ui, Tailwind v4, tsconfig path aliases.
  - `.env.example` covering all secrets and public keys.
- Configuration & Environment Variables:
  - Runtime: Vercel Node.js 20; do not use Bun on Vercel.
  - Supabase: `NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY`, `SUPABASE_SERVICE_ROLE_KEY`
  - R2 S3: `R2_ACCOUNT_ID`, `R2_BUCKET`, `R2_ACCESS_KEY_ID`, `R2_SECRET_ACCESS_KEY`, `R2_S3_ENDPOINT`
  - Providers: `ELEVENLABS_API_KEY`, `FAL_KEY`
  - Stripe (web): `STRIPE_SECRET_KEY`, `NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY`, `STRIPE_WEBHOOK_SECRET`
  - RevenueCat (mobile): `REVENUECAT_WEBHOOK_SECRET`
  - Email: `RESEND_API_KEY`
  - App: `APP_ORIGIN`
  - Expo: `EXPO_PUBLIC_API_URL`, `EXPO_PUBLIC_SUPABASE_URL`, `EXPO_PUBLIC_SUPABASE_ANON_KEY`, `EXPO_PUBLIC_REVENUECAT_API_KEY`, deep link scheme in `app.json`

---

## CI/CD
- Vercel Git integration for preview deployments.
- Optional GitHub Actions: install → lint → typecheck → test → build.
- Required checks on PRs (types + lint + build).

- Vercel runtime/build specifics:
  - Use Node.js 20 (set `"engines": { "node": "20.x" }` in `package.json`).
  - Use `pnpm` or `npm` for `installCommand`/`buildCommand` (no Bun on Vercel).
  - Ensure Next.js route handlers that need SDKs (tRPC, S3) use the Node.js runtime (not Edge).

- Expo mobile:
  - EAS Build for iOS/Android distributions; EAS Update for OTA UI fixes.
  - Use development builds for local iteration; avoid Expo Go for production features.


---

## Cost/Quotas
- Rate-limit `music.create` per user and globally.
- Budget guardrails for ElevenLabs + Fal.ai (daily caps via env).
- R2 lifecycle rules to age out temp files; optional cold storage.

---

## Security
- Secrets only server-side; never expose provider keys in client.
- Webhook signature verification and idempotent updates for billing (Stripe/RevenueCat) (store last event id/hash).
- RLS policies on all tables for select/insert/update/delete.
- Private R2 with presigned URLs if privacy required; otherwise public R2 with unguessable keys.

---

## Testing
- Unit tests for `server/lib/{elevenlabs,fal,r2}` with provider mocks.
- Integration tests for tRPC routers (mock Supabase or use test schema).
- Contract tests for billing webhooks (Stripe/RevenueCat), optional provider webhook tests deferred to Hardening.
- Playwright E2E: generate → complete → play audio → delete; error cases.

---

## tRPC Router Signatures (Reference)
- music:
  - `create(input: { spaceId: string; prompt: string; title?: string; style?: string; makeInstrumental?: boolean })`
  - `status(input: { id?: string; generationId?: string })`
  - `list(input: { cursor?: string; limit?: number; status?: string })`
  - `delete(input: { id: string })`
- artwork:
  - `create(input: { prompt: string; model?: string })`
  - `list(input: { cursor?: string; limit?: number })`
  - `delete(input: { id: string })`
- video:
  - `create(input: { artworkId: string; prompt?: string; model?: string; duration?: number; mode?: string })`
  - `list(input: { cursor?: string; limit?: number })`
  - `delete(input: { id: string })`
- spaces:
  - `create(input: { name: string; slug?: string; visibility?: 'private'|'public'; chatEnabled?: boolean; backgroundArtworkId?: string; backgroundVideoId?: string; description?: string })`
  - `update(input: { id: string; name?: string; visibility?: 'private'|'public'; chatEnabled?: boolean; backgroundArtworkId?: string; backgroundVideoId?: string; description?: string })`
  - `delete(input: { id: string })`
  - `list(input: { cursor?: string; limit?: number; ownerOnly?: boolean })`
  - `getBySlug(input: { slug: string })`
  - `setBackground(input: { spaceId: string; backgroundArtworkId?: string; backgroundVideoId?: string })`
  - `reorderSongs(input: { spaceId: string; songIdsInOrder: string[] })`
- spaceMessages:
  - `list(input: { spaceId: string; cursor?: string; limit?: number })`
  - `post(input: { spaceId: string; message: string })`
- billing (web):
  - `createCheckoutSession(input: { plan: 'pro_monthly'|'pro_yearly'; successUrl?: string; cancelUrl?: string })`
  - `createPortalSession()`
  - `getSubscription()`

---

## Project Structure (Proposed)
```
app/
  music/page.tsx
  spaces/
    page.tsx         # list/manage spaces
  space/[slug]/page.tsx  # public space view
  artwork/page.tsx
  video/page.tsx
  api/
    trpc/[trpc]/route.ts
    webhooks/
      stripe/route.ts
      revenuecat/route.ts
components/
  music/
  artwork/
  video/
  spaces/
  ui/
mobile/                   # Expo app (optional colocated or separate repo)
  app/
    (tabs)/index.tsx
    spaces/index.tsx
    space/[slug].tsx
    account.tsx
  app.json / app.config.ts
  package.json
server/
  trpc/
    context.ts
    routers/
      index.ts
      music.ts
      artwork.ts
      video.ts
      spaces.ts
      billing.ts
  lib/
    elevenlabs.ts
    fal.ts
    r2.ts
    supabase.ts
    stripe.ts
    revenuecat.ts
db/
  migrations/
  schema.sql
  policies.sql
lib/
  types.ts
  utils.ts
```


# Tasks

Check off the boxes as you proceed to complete each task.

### Phase 0: Bootstrap (Dev Env Ready)
- [x] Remove Cloudflare Worker code and D1 schemas.
- [x] Remove Worker-based UI and scripts.
- [x] Delete Suno/Udio/Musikai configs.
- [x] Initialize Next.js (App Router) with TypeScript (local dev may use Bun).
- [ ] Add Tailwind v4; install shadcn/ui; generate Button/Input/Card/Toast. (Tailwind + shadcn init + Button done; Input/Card pending; Toast replaced by Sonner per shadcn)
- [x] Install tRPC server + client; create `app/api/trpc/[trpc]/route.ts` and base `routers/index.ts`.
- [x] Install TanStack Query; set provider in `app/layout.tsx`; SSR hydration.
- [x] Add `.env.example` (Supabase, R2, ElevenLabs, Fal, Resend, Stripe, APP_ORIGIN).
- [x] Add ESLint/Prettier configs; TS strict; pre-commit hooks (optional).

Acceptance Criteria
- [x] app runs (`pnpm dev`/`npm run dev`), health route, baseline UI. (`bun dev` optional for local only.)

### Phase 1: Auth & DB (Supabase)
- [x] Supabase setup:
  - [x] Install SDK; add server helpers (`server/lib/supabase.ts`) and client helpers; wire auth UI (sign in/out).
  - [x] Configure env: `NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY`, `SUPABASE_SERVICE_ROLE_KEY`.
  - [x] Add tRPC context to include authenticated user.
- [x] Schema creation (run as migration):
  - [x] Tables: `spaces`, `songs` (with `space_id` and `position`), `artwork`, `videos`, `space_messages`, `user_subscriptions`.
  - [x] Indexes: `idx_spaces_user_created`, `idx_songs_user_created`, `idx_songs_space_pos`, `uidx_songs_space_position`, `idx_artwork_user_created`, `idx_videos_user_created`, `idx_space_messages_space_created`.
  - [x] Triggers: `set_updated_at()` for `songs`, `spaces`, `user_subscriptions`.
  - [x] Constraints: single background check on `spaces` to ensure only one of `background_artwork_id` or `background_video_id` is set.
- [x] RLS policies:
  - [x] `spaces`: select public or own; modify own.
  - [x] `songs`: select own or songs in public spaces; modify own.
  - [x] `artwork`/`videos`: select/modify own.
  - [x] `space_messages`: select for public/own spaces; insert/delete own.
- [ ] Seed (optional):
  - [ ] Seed one demo user (local only), one space, and a couple of placeholder rows for songs/artwork to exercise UI.

Acceptance Criteria
- [x] Able to sign up/sign in/out; session persists and is available in tRPC context.
- [x] Migrations apply cleanly on a fresh database and are idempotent.
- [x] RLS blocks cross-user access: User A cannot read/modify User B rows.
- [x] Public spaces are selectable by other users; private spaces are not.
- [x] `songs` are required to have a `space_id` and are ordered by `position` within a space.
- [x] `spaces` enforce single background (image XOR video) via constraint.
- [x] All listed indexes and triggers exist; simple queries use the expected indexes.

### Phase 2: Space Model
- [ ] Spaces CRUD:
  - [ ] Create/edit/delete space with fields: `name`, `slug`, `visibility`, `chat_enabled`, `description`.
  - [ ] Slug generation and uniqueness validation; allow manual override.
- [ ] Background selection:
  - [ ] Set `background_artwork_id` or `background_video_id` (mutually exclusive) from generated media.
  - [ ] Preview background in edit form; enforce exclusivity in UI.
- [ ] Songs within a Space:
  - [ ] List songs scoped to `space_id` ordered by `position`.
  - [ ] Reorder via drag-and-drop; update `position` atomically.
  - [ ] Remove song from space (hard delete the song row).
- [ ] Space page `/space/[slug]`:
  - [ ] Public view that renders background (image or looping video) and a simple playlist UI.
  - [ ] Respect `visibility`; 404 or gating for private spaces.
- [ ] Chat toggle:
  - [ ] If `chat_enabled`, show basic message list (reads from `space_messages`), posting gated to owner for now (MVP).

Acceptance Criteria
- [ ] Users can create, edit, and delete their own spaces; slugs are unique and routable.
- [ ] Background selection works and enforces exactly one background type.
- [ ] Songs list in a space is ordered and persists after page reload; reordering updates positions correctly.
- [ ] Public spaces render at `/space/[slug]`; private spaces are inaccessible to other users.
- [ ] If chat is enabled, messages for a space can be read; posting is restricted to the owner (MVP scope).

### Phase 3: ElevenLabs (Music Gen and Storage)
- [ ] Implement `server/lib/elevenlabs.ts`:
  - [ ] startGeneration(prompt/options) -> { generationId }
  - [ ] fetchStatus(generationId)
  - [ ] downloadAudio(url/stream) (stream to R2)
- [ ] Implement `server/lib/r2.ts` S3 client: `putObject`, `publicUrl` (no presign in MVP).
- [ ] tRPC `music` router:
  - [ ] `create` (insert row with `spaceId` and next `position`, call ElevenLabs, set `generating`)
  - [ ] `status` (optional polling)
  - [ ] `list` (paginated)
  - [ ] `delete` (remove DB + R2)
- [ ] Poll ElevenLabs for completion; when complete finalize song (R2 upload + DB update).
- [ ] `/music` page:
  - [ ] Generation form (title/style/instrumental/prompt presets), validation, and model options.
  - [ ] List with statuses, durations, createdAt; skeleton loading; empty states.
  - [ ] `<audio controls>` playback; errors surfaced; retry on 404.
  - [ ] Delete with confirmation; optimistic updates.
- [ ] Deliverables: create → generate → complete → play; errors handled; delete works.

Acceptance Criteria
- [ ] Creating a song triggers an ElevenLabs job and inserts a `songs` row tied to a `space_id` with the correct next `position`.
- [ ] On completion, audio is stored in R2 and the song row includes a working public R2 URL; statuses transition as expected.
- [ ] Listing is paginated and returns only the caller's songs (or songs in public spaces if implemented server-side).
- [ ] Deleting a song removes the DB row and its R2 object.

### Phase 4: Fal.ai (Background Artwork Generation and Storage)
- [ ] Implement `server/lib/fal.ts` (queue calls, polling helpers, parse outputs).
- [ ] Routers `artwork` and `video`: `create`, `list`, `delete`; persist to R2.
- [ ] `/artwork` form (model select), gallery grid; delete.
- [ ] `/video` form (select artwork, duration/model, mode), list with thumbnails.
- [ ] Deliverables: image/video E2E working with persistence and UI.

Acceptance Criteria
- [ ] Users can generate artwork and videos via Fal.ai; rows are created and updated with statuses.
- [ ] Generated media is stored in R2 with working public URLs.
- [ ] Users can view their own artwork/video lists and delete their own items.
- [ ] A space can successfully set either an image or a video as its background from the generated media.

### Phase 5: Billing & Entitlements
- [ ] Implement `server/lib/stripe.ts` (create customer on signup, create checkout session, portal session, verify webhooks).
- [ ] Add Stripe webhook handler `/api/webhooks/stripe` with signature verification + idempotency.
- [ ] `billing` router:
  - [ ] `createCheckoutSession(plan)` (Pro monthly/yearly), returns URL.
  - [ ] `createPortalSession()` for managing subscription.
  - [ ] `getSubscription()` returns current plan/status.
- [ ] `user_subscriptions` table: `plan` (`free`|`pro`), `stripe_customer_id`, `stripe_subscription_id`, `status`, `current_period_end`.
- [ ] Entitlements: enforce Space limits in server-side routers (free: 1 total; pro: up to 10 total).
- [ ] UI: `/pricing` with plan details; upgrade/downgrade flows; `/account` shows plan & manage button.

Acceptance Criteria
- [ ] Stripe checkout session can be created and completed in test mode; subscription status persists.
- [ ] Portal session opens successfully and updates reflect in `user_subscriptions`.
- [ ] Entitlements enforced in server routers: Free users cannot create a second space; Pro users can create up to 10.
- [ ] `/account` displays plan and a working "Manage billing" link; `/pricing` shows correct plan options.

#### Phase 6: SFX Overlays
- [ ] SFX catalog seeded (`sfx_effects`), UI selector with categories and live preview.
- [ ] Web Audio API mixers on web; `expo-av` dual playback on mobile with gain controls.
- [ ] Persist per-Space selections (`space_sfx`) and default gains; apply on Space load.
- [ ] Optional: basic export pre-mix (server or external service) to create shareable merged audio in R2.
- [ ] Deliverables: users can layer ambient SFX over tracks in Spaces and share the experience.

Acceptance Criteria
- [ ] Users can add one or more SFX overlays on top of a playing track on web; gains are adjustable and persist per space.
- [ ] On mobile (Expo), two-sound playback (base+SFX) works with independent gain controls.
- [ ] SFX selections are persisted (`space_sfx` or metadata) and applied when loading a Space.

### Phase 7: Optimizations, Documentation, Hardening
- [ ] Performance & UX
  - [ ] Optimize initial page loads and route transitions; audit bundle size and enable code-splitting where needed.
  - [ ] Use HTTP caching where safe for public assets; prefetch queries in Space view.
  - [ ] Reduce client re-renders in playlist and artwork grids; memoization where appropriate.
- [ ] Resilience & Reliability
  - [ ] Add standardized retry/backoff for provider/network failures.
  - [ ] Implement reconciler job to resolve stuck `generating` > N minutes (mark failed or retry).
  - [ ] Idempotency guards around external calls; ensure safe replays.
- [ ] Observability & Runbooks
  - [ ] Structured logs with request IDs; surface key metrics (generation latency, error rates, webhook successes).
  - [ ] Sentry (optional) wired for server and client with sensible sampling.
  - [ ] Document runbooks for stuck jobs, missing R2 objects, and webhook failures.
- [ ] Security & Ops Hygiene
  - [ ] Finalize Vercel envs; document secrets rotation; tighten permissions.
  - [ ] Least-privilege R2 credentials; lifecycle rules for temp files.
- [ ] Optional
  - [ ] Introduce provider webhooks for ElevenLabs and Fal.ai; replace polling with idempotent webhook processing.

Acceptance Criteria
- [ ] Measurable improvements to page load and interaction timings (define target budgets; e.g., Space TTI < 2.0s on mid-tier device).
- [ ] Reconciler detects and resolves stuck jobs in a test scenario; retries respect backoff and idempotency.
- [ ] Logs/metrics available for key flows; at least one runbook per major failure mode is in the repo.
- [ ] No PII in logs; environment variables and secrets documented; R2 lifecycle rules active for temp objects.

---

## Runbooks
- Billing Webhook Failure (Stripe/RevenueCat): inspect logs; replay with saved payload; idempotency avoids duplicates.
- Stuck Job (P7+): run reconciler; poll provider; mark failed if exceeding threshold.
- Missing R2 Object: re-download from provider URL if retained; otherwise mark failed and notify.
- Billing:
  - Checkout issues: verify product/price IDs, domain origin, webhook secret, and customer linkage.
  - Sync drift: run `getSubscription()` or backfill via webhook replay (Stripe) or resend recent events (RevenueCat).


---

## LATER: Expo Mobile App (Companion)

### Goals
- Provide a mobile-first companion to browse Spaces, play audio, and view artwork/videos.
- Support sign-in with Supabase, upgrade to Pro (RevenueCat paywalls in-app), and basic Space management (create/edit/delete within entitlements).
- Deliverables: working upgrade to Pro (web via Stripe, mobile via RevenueCat), webhook sync of subscription state, gating of Space creation.
- Implement RevenueCat webhook handler `/api/webhooks/revenuecat` (verify signature) to sync `user_subscriptions.plan` based on mobile entitlements.
- Mobile: use RevenueCat SDK for paywalls; webhook sync reflects plan on `/account`.

#### Expo Mobile MVP
- Initialize Expo app (TypeScript, Expo Router); configure deep linking scheme.
- Supabase Auth with PKCE (mobile redirect), session storage; tRPC client pointing to `EXPO_PUBLIC_API_URL`.
- Screens: Spaces list (owned + public), Space view (`/space/[slug]`), play audio via `expo-av`, show artwork/video.
- Actions: create/edit/delete Space (respect entitlements), toggle privacy/chat.
- Generation form (mobile-optimized) for music prompts; submit to same `music.create` endpoint.
- Billing: use RevenueCat paywalls in-app; webhook sync updates plan; `/account` reflects plan.
- Deliverables: signed-in users can browse/manage Spaces, play media, and upgrade to Pro.

### Stack
- **Framework**: Expo (React Native), TypeScript
- **Networking**: tRPC client over HTTPS to the Next.js API
- **Auth**: Supabase Auth (PKCE with deep link callbacks)
- **Storage/Media**: Stream from public R2 URLs (unguessable keys); use `expo-av` for audio/video playback
- **Billing**: RevenueCat for in-app purchases/subscriptions
- **Navigation**: Expo Router (file-based)
- **State/Data**: TanStack Query (React Query) for caching and offline-friendly fetches
- **Updates**: EAS Update for OTA

### Features
- Auth: Sign-in/out, account screen (plan, upgrade via RevenueCat paywall)
- Spaces: list (owned + public), create/edit/delete (respect Free vs Pro limits), toggle visibility and chat
- Media: play audio (seek), display artwork, play video previews (mute by default)
- Share: copy public Space link and system share sheet

### API Contracts (tRPC mobile-safe)
- Use the same routers as web: `music`, `artwork`, `video`, `spaces`, `billing` (read-only where appropriate)
- Ensure CORS and auth headers work with mobile; return public R2 URLs (no CDN in MVP; presign later if private)

### Dev/Release
- Dev: Expo Go for rapid iteration
- Build: EAS Build for iOS/Android
- Release: EAS Submit; OTA via EAS Update for minor UI changes

### Considerations
- Background audio (optional): consider `expo-av` background mode and media controls
- Offline: cache listing data and thumbnails; stream media when online
- Security: never embed secrets; rely on Supabase PKCE and server-side Stripe (web) and RevenueCat entitlements (mobile)

